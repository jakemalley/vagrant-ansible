---
- name: add vimrc settings for YAML
  lineinfile:
    path: /root/.vimrc
    create: true
    line: "{{ line }}"
  loop_control:
    loop_var: line
  loop:
    - au! BufNewFile,BufReadPost *.{yaml,yml} set filetype=yaml
    - autocmd FileType yaml setlocal ts=2 sts=2 sw=2 expandtab autoindent

- name: install bash-completion
  package:
    name: bash-completion
    state: present

- name: add bash completion
  lineinfile:
    path: /root/.bashrc
    create: true
    line: "{{ line }}"
  loop_control:
    loop_var: line
  loop:
    - "## export KUBECONFIG=/etc/rancher/k3s/k3s.yaml"
    - source /usr/share/bash-completion/bash_completion
    - source <(kubectl completion bash)
    - alias k=kubectl
    - complete -F __start_kubectl k

- name: set k3s server token
  block:
    - name: lookup k3s server token
      slurp:
        src: "{{ __k3s_server_token_file }}"
      register: r_slurp_k3s_server_token
      when: k3s_primary | bool

    - name: set fact for k3s server token
      set_fact:
        __k3s_server_token: "{{ r_slurp_k3s_server_token['content'] | b64decode }}"
      when: k3s_primary | bool

  rescue:
    - name: generate k3s server token
      set_fact:
        __k3s_server_token: "{{ lookup('password', '/dev/null chars=ascii_lowercase,ascii_uppercase,digits length=64') }}"

  always:
    - name: write k3s server token
      copy:
        dest: "{{ __k3s_server_token_file }}"
        owner: root
        group: root
        mode: 0400
        content: "{{ hostvars[groups['servers'][0]]['__k3s_server_token'] }}"

- name: configure k3s servers
  import_tasks: config.yml

- name: run installer server nodes
  include_tasks: run_installer.yml

- name: configure haproxy
  include_role:
    name: haproxy
  vars:
    haproxy_keepalived_interface: "{{ __k3s_interface }}"
    haproxy_ip: "{{ __node_external_ip }}"
    haproxy_k3s_api_servers: "{{ __server_node_ip_addresses }}"
  when: haproxy_keepalived_vip | default("", true) != ""

- name: start the k3s server service is started
  service:
    name: "{{ __k3s_server_service }}"
    state: started
    enabled: true
  throttle: 1
  delay: 5

- name: pause for 5 seconds to wait for k3s node token
  pause:
    seconds: 5

- name: create root's kubeconfig
  block:
    - name: create .kube dir
      file:
        path: /root/.kube
        state: directory
        mode: "0750"
        owner: root
        group: root

    - name: copy k3s.yaml to ~/.kube/config
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        remote_src: true
        dest: /root/.kube/config
        owner: root
        group: root
        mode: "0600"
      register: r_copy_kubeconfig

    - name: update ~/.kube/config with vip
      lineinfile:
        path: /root/.kube/config
        regexp: "^    server:"
        line: "    server: https://{{ haproxy_keepalived_vip }}:6443"
      when:
        haproxy_keepalived_vip | default("", true) != ""

- name: read k3s node token from primary
  block:
    - name: lookup k3s node token
      slurp:
        src: "{{ __k3s_default_node_token_file }}"
      register: r_slurp_k3s_node_token

    - name: set fact for k3s node token
      set_fact:
        __k3s_node_token: "{{ r_slurp_k3s_node_token['content'] | b64decode }}"
  when: k3s_primary | bool
