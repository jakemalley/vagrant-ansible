## Ansible Managed!

## Global settings
global
    chroot  /var/lib/haproxy
    pidfile /var/run/haproxy.pid
    maxconn 10000
    user    haproxy
    group   haproxy
    daemon

    {% if haproxy_cfg_stats_socket %}
    # turn on stats unix socket
    stats socket /var/lib/haproxy/stats
    {% endif %}

    # utilize system-wide crypto-policies
    ssl-default-bind-ciphers PROFILE=SYSTEM
    ssl-default-server-ciphers PROFILE=SYSTEM

## Defaults for 'frontend' and 'backend' blocks
defaults
    mode                    tcp
    log                     global
    option                  tcplog
    option                  dontlognull
    option                  dontlog-normal
    option                  http-server-close
    option                  redispatch
    retries                 3
    timeout http-request    10s
    timeout queue           30s
    timeout connect         10s
    timeout client          30s
    timeout server          30s
    timeout http-keep-alive 10s
    timeout check           15s
    maxconn                 10000

## Frontends
frontend fe-k3s-api-6443
    bind {{ haproxy_k3s_api_bind }}:6443
    mode tcp
    option tcplog

    acl local_not_avail nbsrv(be-k3s-api-6443-local) lt 1
    use_backend be-k3s-api-6443-remote if local_not_avail

    default_backend be-k3s-api-6443-local

## Backends
backend be-k3s-api-6443-local
    balance roundrobin
    mode tcp

    server local1 127.0.0.1:8443 check

backend be-k3s-api-6443-remote
    balance roundrobin
    mode tcp

{% for server in haproxy_k3s_api_servers | reject('match', haproxy_ip) %}
    server backend{{loop.index}} {{ server }}:8443 check
{% endfor %}
